<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ene-Connect | 地域シェア型エネルギー診断</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        #map { height: 450px; width: 100%; border-radius: 1.5rem; z-index: 1; cursor: crosshair; }
        .step-content { display: none; }
        .active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .btn-option { @apply w-full text-left p-4 rounded-xl border-2 border-slate-100 hover:border-orange-500 hover:bg-orange-50 transition-all flex justify-between items-center font-bold text-slate-700 mb-3; }
        .calc-note { @apply text-[10px] text-slate-400 mt-1 leading-relaxed block; }
        .watermark-fixed { position: fixed; bottom: 20px; right: 20px; pointer-events: none; z-index: 9999; font-weight: 900; font-size: 0.7rem; letter-spacing: 0.15em; opacity: 0.4; color: #94a3b8; text-transform: uppercase; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

<div class="watermark-fixed">its_um_ray</div>

<!-- 質問ウィザード -->
<div id="wizard-screen" class="min-h-screen flex items-center justify-center p-4 bg-slate-100">
    <div class="bg-white p-8 md:p-12 rounded-[2.5rem] shadow-2xl max-w-xl w-full">
        <div class="flex gap-2 mb-8" id="progress-dots">
            <div class="h-2 flex-1 rounded-full bg-orange-500"></div>
            <div class="h-2 flex-1 rounded-full bg-slate-200"></div>
            <div class="h-2 flex-1 rounded-full bg-slate-200"></div>
        </div>

        <div id="step-1" class="step-content active">
            <h2 class="text-2xl font-black mb-2">どちらにお住まいですか？</h2>
            <p class="text-slate-500 mb-6 text-sm">地域の日射量データを読み込みます。</p>
            <select id="pref-select" onchange="handlePrefChange()" class="w-full p-4 rounded-xl border-2 border-slate-100 focus:border-orange-500 outline-none bg-white font-bold">
                <option value="">都道府県を選択してください</option>
            </select>
            <button id="btn-to-step2" disabled onclick="goToStep(2)" class="mt-8 w-full py-4 bg-slate-200 text-white rounded-xl font-bold transition-all shadow-lg">次へ進む</button>
        </div>

        <div id="step-2" class="step-content">
            <h2 class="text-2xl font-black mb-2">現在の電気代単価は？</h2>
            <p class="text-slate-500 mb-6 text-sm">地域の相場と比較して節約額を計算します。</p>
            <div id="utility-options" class="space-y-3"></div>
        </div>

        <div id="step-3" class="step-content">
            <h2 class="text-2xl font-black mb-2 text-center">何を最も重視しますか？</h2>
            <p class="text-slate-500 mb-6 text-sm text-center">シェア型エネルギーの活用の形を提案します。</p>
            <div class="space-y-3">
                <button onclick="finishWizard('money')" class="btn-option group">
                    <div><span class="block text-lg">安さ重視</span><span class="text-[10px] text-slate-400 font-normal">地域のみんなで安く電気を使いたい</span></div>
                    <i data-lucide="banknote" class="text-slate-300 group-hover:text-orange-500"></i>
                </button>
                <button onclick="finishWizard('env')" class="btn-option group">
                    <div><span class="block text-lg">環境重視</span><span class="text-[10px] text-slate-400 font-normal">地域の再エネ100%を目指したい</span></div>
                    <i data-lucide="leaf" class="text-slate-300 group-hover:text-emerald-500"></i>
                </button>
                <button onclick="finishWizard('town')" class="btn-option group">
                    <div><span class="block text-lg">自立重視</span><span class="text-[10px] text-slate-400 font-normal">災害に強く、地域にお金が回る街にしたい</span></div>
                    <i data-lucide="home" class="text-slate-300 group-hover:text-blue-500"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- メイン画面 -->
<div id="main-sim" class="hidden min-h-screen pb-12">
    <header class="bg-white border-b px-6 py-4 flex justify-between items-center sticky top-0 z-[1000]">
        <div class="flex items-center gap-3">
            <div class="bg-orange-500 p-1.5 rounded-lg text-white"><i data-lucide="zap" class="w-5 h-5"></i></div>
            <span class="font-black text-xl tracking-tighter uppercase">Ene-Connect Shared</span>
        </div>
        <div id="interest-label" class="text-[10px] font-bold px-4 py-1.5 rounded-full bg-slate-100 border"></div>
    </header>

    <div class="max-w-7xl mx-auto px-4 mt-8">
        <!-- シェア状況のサマリー -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-200">
                <p class="text-[10px] font-bold text-slate-400 uppercase">協力世帯数</p>
                <p class="text-2xl font-black"><span id="house-count">0</span> <span class="text-sm font-normal text-slate-400">世帯</span></p>
            </div>
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-200">
                <p class="text-[10px] font-bold text-slate-400 uppercase">地域の電気自給率</p>
                <div class="flex items-center gap-2">
                    <div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden">
                        <div id="self-rate-bar" class="h-full bg-orange-500 transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <span id="self-rate-text" class="text-lg font-black">0%</span>
                </div>
            </div>
            <div class="bg-orange-500 p-5 rounded-3xl shadow-lg text-white">
                <p class="text-[10px] font-bold opacity-80 uppercase text-orange-100">あなたの電気代単価</p>
                <p class="text-2xl font-black"><span id="my-unit-price">--</span> <span class="text-sm font-normal opacity-80">円/kWh</span></p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- マップ -->
            <div class="lg:col-span-8">
                <div class="bg-white p-3 rounded-[2.5rem] shadow-sm border border-slate-200 relative">
                    <div id="map"></div>
                    <div class="absolute top-6 left-6 z-[500] bg-white/90 backdrop-blur p-4 rounded-2xl shadow-xl border border-orange-100 max-w-xs">
                        <p id="dynamic-advice" class="text-[11px] leading-relaxed text-slate-700 font-medium font-bold">
                            地図をクリックして、近所に太陽光パネルを設置してみましょう。
                        </p>
                    </div>
                </div>
                <div class="mt-4 flex justify-between px-4">
                    <p class="text-[11px] text-slate-400 tracking-wider">※1世帯あたり5kWパネル、年間4,500kWh消費と仮定</p>
                    <button onclick="clearPanels()" class="text-[11px] text-red-500 font-bold hover:underline">リセット</button>
                </div>
            </div>

            <!-- 結果詳細 -->
            <div class="lg:col-span-4 space-y-4">
                <div class="bg-white p-7 rounded-[2.5rem] shadow-xl border-t-8 border-orange-500">
                    <h3 class="text-[11px] font-black text-slate-400 mb-4 flex items-center gap-2">
                        <i data-lucide="banknote" class="w-4 h-4"></i> あなたの年間節約額（予想）
                    </h3>
                    <div class="flex items-baseline gap-1">
                        <span id="display-savings" class="text-5xl font-black text-slate-800 tracking-tighter">0</span>
                        <span class="text-sm font-bold text-slate-400">円</span>
                    </div>
                    <div class="mt-6 space-y-3">
                        <div class="p-3 bg-slate-50 rounded-xl">
                            <p class="text-[10px] text-slate-400 font-bold">節約の仕組み</p>
                            <p id="logic-text" class="text-[11px] text-slate-600 leading-tight mt-1">
                                近所の再エネが増えるほど、電力会社から買う高い電気が減り、地域シェアの安い電気（20円）を使える割合が増えます。
                            </p>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-900 p-7 rounded-[2.5rem] shadow-xl text-white">
                    <h3 class="text-[11px] font-black text-emerald-400 mb-4 flex items-center gap-2">
                        <i data-lucide="leaf" class="w-4 h-4"></i> 地域全体の環境貢献
                    </h3>
                    <div class="flex items-baseline gap-1">
                        <span id="display-co2" class="text-3xl font-black">0</span>
                        <span class="text-xs text-slate-500">kg-CO2 削減</span>
                    </div>
                    <p class="calc-note text-slate-500 mt-2">地域の協力で削減される二酸化炭素量。杉の木 <span id="display-trees" class="text-emerald-400">0</span> 本分に相当。</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const CONFIG = {
        houseCapacityKW: 5,         // 1軒あたり5kW
        avgHouseConsumption: 4500,  // 年間消費 4500kWh
        sharePrice: 20,             // 地域シェア単価
        co2Unit: 0.441,             // kg/kWh
        treeUnit: 14                // kg/本
    };

    const areaData = {
        hokkaido: { potential: 1050, rate: 36, latlng: [43.0642, 141.3469] },
        tohoku:   { potential: 1100, rate: 32, latlng: [38.2682, 140.8694] },
        kanto:    { potential: 1180, rate: 34, latlng: [35.6895, 139.6917] },
        chubu:    { potential: 1250, rate: 31, latlng: [35.1815, 136.9064] },
        hokuriku: { potential: 1100, rate: 29, latlng: [36.5613, 136.6562] },
        kansai:   { potential: 1250, rate: 30, latlng: [34.6937, 135.5023] },
        chugoku:  { potential: 1450, rate: 31, latlng: [34.6618, 133.9344] },
        shikoku:  { potential: 1350, rate: 31, latlng: [33.5597, 133.5311] },
        kyushu:   { potential: 1320, rate: 29, latlng: [33.5904, 130.4017] },
        okinawa:  { potential: 1200, rate: 39, latlng: [26.2124, 127.6809] }
    };

    const prefList = [
        { name: "北海道", area: "hokkaido" }, { name: "東京都", area: "kanto" }, { name: "大阪府", area: "kansai" }, 
        { name: "愛知県", area: "chubu" }, { name: "福岡県", area: "kyushu" }, { name: "宮城県", area: "tohoku" }
    ];

    let userState = { pref: "", area: "", gridPrice: 31, interest: "" };
    let map, panels = [];

    window.onload = () => {
        const select = document.getElementById('pref-select');
        prefList.forEach((p, idx) => {
            const opt = document.createElement('option');
            opt.value = idx; opt.innerText = p.name;
            select.appendChild(opt);
        });
        lucide.createIcons();
    };

    function handlePrefChange() {
        const idx = document.getElementById('pref-select').value;
        if (idx !== "") {
            userState.pref = prefList[idx].name;
            userState.area = prefList[idx].area;
            document.getElementById('btn-to-step2').disabled = false;
            document.getElementById('btn-to-step2').classList.replace('bg-slate-200', 'bg-orange-500');
        }
    }

    function goToStep(step) {
        document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
        document.getElementById(`step-${step}`).classList.add('active');
        if (step === 2) {
            const utilityDiv = document.getElementById('utility-options');
            const data = areaData[userState.area];
            utilityDiv.innerHTML = `
                <button onclick="setUtility(${data.rate})" class="btn-option">標準的なプラン (${data.rate}円) <i data-lucide="chevron-right"></i></button>
                <button onclick="setUtility(${data.rate + 5})" class="btn-option">新電力・高めプラン (${data.rate + 5}円) <i data-lucide="chevron-right"></i></button>
            `;
            lucide.createIcons();
        }
    }

    function setUtility(rate) {
        userState.gridPrice = rate;
        goToStep(3);
    }

    function finishWizard(interest) {
        userState.interest = interest;
        document.getElementById('wizard-screen').classList.add('hidden');
        document.getElementById('main-sim').classList.remove('hidden');
        document.getElementById('interest-label').innerText = `目的: ${interest === 'money' ? '安さ' : interest === 'env' ? '環境' : '自立'}`;
        initSimulation();
    }

    function initSimulation() {
        const data = areaData[userState.area];
        map = L.map('map', { scrollWheelZoom: false }).setView(data.latlng, 18);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        map.on('click', (e) => {
            const marker = L.marker(e.latlng, {
                icon: L.divIcon({
                    html: `<div class="bg-orange-500 w-4 h-4 rounded-full border-2 border-white shadow-lg pulse"></div>`,
                    className: '', iconSize: [16, 16]
                })
            }).addTo(map);
            panels.push(marker);
            updateStats();
        });
        updateStats();
    }

    function updateStats() {
        const stats = areaData[userState.area];
        const count = panels.length;
        
        // --- ここが「シェア型」のキモ ---
        // 1軒増えるごとに地域自給率が5%アップすると仮定（上限80%）
        const selfSufficiencyRate = Math.min(count * 0.05, 0.8);
        
        // あなたの電気代単価 = (自給率 × シェア単価20円) + ((1-自給率) × 元の単価)
        const myUnitPrice = (selfSufficiencyRate * CONFIG.sharePrice) + ((1 - selfSufficiencyRate) * userState.gridPrice);
        
        // 年間節約額 = 年間消費量 × (元の単価 - 新しい単価)
        const savings = CONFIG.avgHouseConsumption * (userState.gridPrice - myUnitPrice);
        
        // 地域全体の環境貢献
        const totalGen = count * CONFIG.houseCapacityKW * stats.potential * 0.8;
        const totalCo2 = totalGen * CONFIG.co2Unit;

        // UI更新
        document.getElementById('house-count').innerText = count;
        document.getElementById('self-rate-text').innerText = Math.round(selfSufficiencyRate * 100) + "%";
        document.getElementById('self-rate-bar').style.width = (selfSufficiencyRate * 100) + "%";
        document.getElementById('my-unit-price').innerText = myUnitPrice.toFixed(1);
        
        animateValue('display-savings', savings);
        animateValue('display-co2', totalCo2);
        document.getElementById('display-trees').innerText = Math.round(totalCo2 / CONFIG.treeUnit);

        updateAdvice(count, selfSufficiencyRate, savings);
    }

    function updateAdvice(count, rate, savings) {
        const advice = document.getElementById('dynamic-advice');
        const logic = document.getElementById('logic-text');
        
        if (count === 0) {
            advice.innerText = "まずはあなたの家、または隣の家にパネルを設置してみましょう。";
        } else if (count < 5) {
            advice.innerText = "良いですね！近所で電気がシェアされ始めました。あなたの単価も少しずつ下がっています。";
        } else if (count < 10) {
            advice.innerText = "協力者が増えてきました！地域自給率がアップし、安い電気が安定して供給されています。";
        } else {
            advice.innerText = "素晴らしい！このエリアはもはや「小さな発電所」です。大手電力に頼らない自立した街になっています。";
        }

        if (userState.interest === 'money') {
            logic.innerText = `現在、地域の電機の${Math.round(rate*100)}%がシェア電気です。この分だけ、あなたの電気代が20円/kWhに置き換わっています。`;
        } else if (userState.interest === 'env') {
            logic.innerText = `再エネの地産地消により、遠くの火力発電所からの送電ロスとCO2を同時に削減できています。`;
        } else {
            logic.innerText = `近所にこれだけパネルがあれば、災害で停電しても地域内でスマホの充電や照明を分け合える安心感があります。`;
        }
    }

    function animateValue(id, value) {
        const el = document.getElementById(id);
        const start = parseInt(el.innerText.replace(/,/g, '')) || 0;
        const duration = 500;
        let startTime = null;
        function step(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = Math.min((timestamp - startTime) / duration, 1);
            const current = Math.floor(progress * (value - start) + start);
            el.innerText = current.toLocaleString();
            if (progress < 1) window.requestAnimationFrame(step);
        }
        window.requestAnimationFrame(step);
    }

    function clearPanels() {
        panels.forEach(p => map.removeLayer(p));
        panels = [];
        updateStats();
    }
</script>
</body>
</html>
